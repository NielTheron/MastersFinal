%==========================================================================
% Niel Theron
% 02-10-2025
%==========================================================================
% The purpose of this function is to estimate the magnetometer measurement
% using the estimated state
%==========================================================================

function zhat_MAG = H_MAG_function(x_est,we,t)

%=== Setup ================================================================
r_I = [x_est(1:3);1];

%==========================================================================

%=== T_I2R ================================================================

theta = we * t;
T_I2R = [cos(theta)    -sin(theta)    0 0;
         sin(theta)     cos(theta)    0 0;
         0              0             1 0;
         0              0             0 1];

r_R = T_I2R * r_I;

%==========================================================================

%=== T_R2L ================================================================

[lat,lon,alt] = ecef2geodetic(wgs84Ellipsoid("km"),r_R(1),r_R(2),r_R(3),"degrees");

%==========================================================================

%=== Transform ============================================================

z_MAG_N = wrldmagm(alt,lat,lon,decyear(2025,1,1),'2025');
z_MAG_N = [z_MAG_N;0];

%==========================================================================

%=== T_N2R ================================================================

lat = deg2rad(lat);
lon = deg2rad(lon);

R_N2R = [-sin(lat)*cos(lon), -sin(lon), -cos(lat)*cos(lon);
         -sin(lat)*sin(lon), cos(lon), -cos(lat)*sin(lon);
         cos(lat), 0, -sin(lat)];

T_N2R = [R_N2R, r_R(1:3);
        0 0 0 1];

%==========================================================================

%=== T_R2I ================================================================

theta = we * t;
T_R2I = [cos(theta)    sin(theta)    0 0;
         -sin(theta)   cos(theta)    0 0;
         0              0             1 0;
         0              0             0 1];

%==========================================================================

%=== T_I2O ================================================================

R_I2O = RI2O(x_est(1:3),x_est(4:6));

T_I2O = [R_I2O         -R_I2O*x_est(1:3);
        zeros(1,3)     1];


%==========================================================================

%=== T_O2B ================================================================

R_O2B = quat2rotm(x_est(7:10).');

T_O2B = [R_O2B          zeros(3,1);
         zeros(1,3)     1];

%==========================================================================

%=== Calculate =============================================================

z_MAG = T_O2B * T_I2O * T_R2I * T_N2R * z_MAG_N;

zhat_MAG = z_MAG(1:3);
%==========================================================================