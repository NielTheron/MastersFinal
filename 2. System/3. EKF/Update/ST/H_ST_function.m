%==========================================================================
% Niel Theron
% FIXED VERSION - Added normalization
% 02-10-2025
%==========================================================================
% The purpose of this function is to create Star Tracker Estimate measurements using
% the estimated state
%
% FIXED: Added normalization to match the measurement model in StarTracker.m
%==========================================================================

function zhat_ST = H_ST_function(x_est)

%=== Star Catalogue =======================================================
Gamma = [ ...
    1.0000   0.0000   0.0000;
    0.0000   1.0000   0.0000;
    0.0000   0.0000   1.0000;
    0.4437   0.6842   0.5788;
   -0.8029   0.5789  -0.1420;
    0.7431   0.4737  -0.4727;
   -0.2413   0.3684   0.8978;
   -0.4447   0.2632  -0.8562;
    0.9275   0.1579   0.3387;
   -0.9231   0.0526   0.3810;
    0.4233  -0.0526  -0.9045;
    0.2955  -0.1579   0.9422;
   -0.8347  -0.2632  -0.4837;
    0.9080  -0.3684  -0.1996;
   -0.5065  -0.4737   0.7205;
   -0.1048  -0.5789  -0.8086;
    0.5576  -0.6842   0.4700;
   -0.6133  -0.7895   0.0254;
    0.3166  -0.8947  -0.3150;
   -0.0000  -1.0000   0.0000].';

% ADDED: Ensure all catalog vectors are normalized
for i = 1:size(Gamma,2)
    Gamma(:,i) = Gamma(:,i) / norm(Gamma(:,i));
end
%==========================================================================

%=== R_I2O ================================================================

R_I2O = RI2O(x_est(1:3),x_est(4:6));

%==========================================================================

%=== R_O2B ================================================================

R_O2B = quat2rotm(x_est(7:10).');

%==========================================================================

%=== Transform and Normalize ==============================================
d = size(Gamma,2);
zhat_ST = zeros(3,d);

for i = 1:d
    % Transform star direction to body frame
    v = R_O2B * R_I2O * Gamma(:,i);
    
    % FIXED: Normalize to match measurement model
    % This ensures consistency with StarTracker.m which normalizes measurements
    zhat_ST(:,i) = v / norm(v);
end

%=========================================================================