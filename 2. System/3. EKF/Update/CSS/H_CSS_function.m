%==========================================================================
% Niel Theron
% 02-10-2025
%==========================================================================
% The purpose of this function is to estimate the coarse sun sensor
% measurements using the estimate state
%==========================================================================

function zhat_CSS = H_CSS_function(x_est)

%=== Sun Vector ===========================================================
Sun_I = [150e6, 0, 0, 1].';            % Sun vector in inertial
%==========================================================================

%=== T_I2O ================================================================
R_I2O = RI2O(x_est(1:3),x_est(4:6));

T_I2O = [R_I2O         -R_I2O*x_est(1:3);
        zeros(1,3)     1];

%==========================================================================

%=== T_O2B ================================================================
R_O2B = quat2rotm(x_est(7:10).');

T_O2B = [R_O2B          zeros(3,1);
         zeros(1,3)     1];

%==========================================================================

%=== Sun_B Vector =========================================================

Sun_B_true = T_O2B * T_I2O * Sun_I;
Sun_B_true = Sun_B_true(1:3);
Sun_B_true = Sun_B_true/norm(Sun_B_true);

%==========================================================================

%=== CSS Sensor directions ================================================
css_dirs = [ 1  0  0;   % +X
            -1  0  0;   % -X
             0  1  0;   % +Y
             0 -1  0;   % -Y
             0  0  1;   % +Z
             0  0 -1];  % -Z
%==========================================================================

%=== Simulate CSS readings (cosine response + max(0)) =====================
css_readings = max(0, css_dirs * Sun_B_true);  % 6x1 vector of readings
%==========================================================================

%=== Reconstruct sun vector estimate from readings ========================
% Weighted sum of sensor directions
Sun_B_est = css_dirs' * css_readings;    % 3x1
zhat_CSS = Sun_B_est / norm(Sun_B_est); % Normalize to unit vector

%==========================================================================