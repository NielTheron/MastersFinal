%==========================================================================
% Niel Theron
% 02-10-2025
%==========================================================================
% The purpose of this function is to estimate the Earth Tracker
% Measurements using the Estimate States
%==========================================================================

function zhat_ET = H_ET_function(x_est,cat,we,t)

%=== T_L2R================================================================
[fx, fy, fz] = geodetic2ecef(wgs84Ellipsoid("km"),cat(1),cat(2),cat(3),"degrees");
f = [fx;fy;fz;1];

%=========================================================================

%=== T_R2I ================================================================

theta = we * t;
T_R2I = [cos(theta)    sin(theta)    0 0;
         -sin(theta)   cos(theta)    0 0;
         0              0            1 0;
         0              0            0 1];

%==========================================================================

%=== T_I2O ================================================================

R_I2O = RI2O(x_est(1:3),x_est(4:6));

T_I2O = [R_I2O         -R_I2O*x_est(1:3);
        zeros(1,3)     1];


%==========================================================================

%=== T_O2B ================================================================

R_O2B = quat2rotm(x_est(7:10).');

T_O2B = [R_O2B          zeros(3,1);
         zeros(1,3)     1];

%==========================================================================

%=== Transform ============================================================

zhat_ET = T_O2B * T_I2O * T_R2I * f;
zhat_ET = zhat_ET(1:3);

end







